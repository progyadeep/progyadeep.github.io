<!DOCTYPE HTML5>
<html>
    <head>
        <title>VFR Navlog &bull; FlyByProggy</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <link rel="stylesheet" href="../res/css.common.css"/>
        <link rel="stylesheet" href="../res/vfr-navlog-manager-dialog.css"/>
        <style>
            button{
                cursor:pointer;
                color:#fff;
                display:inline;
                margin:2 2 2 2;
                border-radius:5px;
                border:none;
                transition: 0.1s;
            }

            button:hover{
                opacity:0.85;
                transition: 0.1s;
            }

            h3, h5{
                margin:0 0 0 0;
            }

            .navlog-container-main{
                display:inline-block;
            }

            .navlog-row{
                display:flex;
                margin-bottom:2px;
            }

            .navlog-row button{
                position: relative;
                top:50%;
                transform: translate(0, -50%);
                margin-left:5;
            }
            
            textarea{
                width:110px;
                resize: none;
                text-align:center;
                font-size:18px;
            }

            input{
                text-align:center;
                font-size:20px;
            }

            .buttons-panel{
                text-align:center;
            }

            .buttons-panel > img{
                width:20px;
                height:20px;
                cursor:pointer;
                transition:0.2s;
            }

            .buttons-panel > img:hover{
                opacity: 0.5;
            }

            .horizontal-center{
                position: relative;
                left:50vw;
                transform: translate(-50%, 0);
            }

            .thick{
                border:solid 2px #000;
            }
        </style>
    </head>

    <body>
        <div id="nav-manager-overlay" class="nav-manager-overlay">
            <br/><br/><br/>
            <div class="nav-manager-dialog">
                <div style="display:flex; justify-content: space-between">
                    <h3>Manage Navlogs</h3>
                    <h3><a href="#" style="color:red" onclick="javascript:closeNavManager()">X</a></h3>
                </div>
                <table id="navlog-list" style="width:100%">
                    <tr><td><span style="color:#a1a1a1;"><i>No navlogs saved on this browser.</i></span></td></tr>
                </table>
            <br/>
            </div>
            <br/><br/><br/> 
        </div>

        <br/>

        <div class="navlog-container-main">
            <h3 align="center">VFR Navlog</h3>
            <h5 align="center">@FlyByProggy</h5><br/>

            <div class="navlog-rows-container" id="nlc">
                <div class="navlog-row">
                    <textarea disabled>From/&#13;To</textarea>
                    <div class="double-cell">
                        <input size="3" value="Alt" disabled/><br/>
                        <input size="3" value="Temp" disabled/>
                    </div>
                    <div class="double-cell">
                        <input size="3" value="TAS" disabled/><br/>
                        <input size="3" value="CAS" disabled/>
                    </div>
                    <input size="3" value="Trk" disabled/>
                    <input size="3" value="W/V" disabled/>
                    <input size="3" value="Hdg" disabled/>
                    <input size="3" value="GS" disabled/>
                    <input size="3" value="Dist" disabled/>
                    <div class="double-cell">
                        <input size="3" value="Fuel" disabled/><br/>
                        <input size="3" placeholder="g.p.h." id="gph"/>
                    </div>
                    <input size="3" value="ETE" disabled/>
                </div>

                <div class="navlog-row">
                    <textarea class="legName"></textarea>
                    <div class="double-cell">
                        <input type="text" size="3" class="alt"/><br/>
                        <input type="text" size="3" class="temp"/>
                    </div>
                    <div class="double-cell">
                        <input type="text" size="3" class="tas"/><br/>
                        <input type="text" size="3" class="cas"/>
                    </div>
                    <input type="text" size="3" class="trk thick" />
                    <input type="text" size="3" class="wv"/>
                    <input type="text" size="3" class="hdg thick"/>
                    <input type="text" size="3" class="gs"/>
                    <input type="text" size="3" class="dist"/>
                    <input type="text" size="3" class="fuel"/>
                    <input type="text" size="3" class="ete"/>
                    <div><button style="background-color:#f00;" onclick="javascript:delLeg(this)">X</button></div>
                </div>
            </div>
        
            <br/>
            <p class="buttons-panel">
                <button style="background-color:#4d4" onclick="javascript:addLeg()"><big>+</big></button> &nbsp;
                <button style="background-color:orange" onclick="javascript:calc()"><big>=</big></button> &nbsp;
                <button style="background-color:rgb(68, 155, 255)" onclick="javascript:recalc()"><big>~</big></button>
            </p>

            <p align="center">Total:-&nbsp; <span id="tot_dist"><b>0</b></span> NM, <span id="tot_fuel"><b>0.0</b></span> Gal, <span id="tot_ete"><b>0.0</b></span> mins</p>

            <br/>
            <p class="buttons-panel">
                <img src="../res/save.svg" onclick="javascript:saveNavlog()"/> &nbsp;&nbsp;
                <img src="../res/menu.svg" onclick="javascript:manageNavlogs()"/> &nbsp;&nbsp;
                <img src="../res/download.svg" /> &nbsp;&nbsp;
                <img src="../res/upload.svg" />
            </p>
        </div>
        
    </body>

    <script tye="text/javascript">
        //-----------GLOBAL JAVASCRIPT VARIABLES-----------------
        var this_navlog_title = "";

        var tot_dist = 0.0;
        var tot_ete= 0.0;
        var tot_fuel= 0.0

        //fetching the fields
        var legNames = document.getElementsByClassName('legName');
        var alts = document.getElementsByClassName('alt');
        var tass = document.getElementsByClassName('tas');
        var tracks = document.getElementsByClassName('trk');
        var winds = document.getElementsByClassName('wv');
        var headings = document.getElementsByClassName('hdg');
        var ground_speeds = document.getElementsByClassName('gs');
        var distances = document.getElementsByClassName('dist');
        var fuel_reqs = document.getElementsByClassName('fuel');
        var etes = document.getElementsByClassName('ete');

        document.getElementById('top-bar-hp-link').onclick= function(){
            window.location.href = '/';
        }

        function addLeg(){
            var div = document.createElement('div');
            div.className = "navlog-row-container";

            div.innerHTML=  "<div class=\"navlog-row\">"
                            +"<textarea class=\"legName\"></textarea>"
                            +"<div class=\"double-cell\">"
                            +"<input type=\"text\" class=\"alt\"/><br/>"
                            +"<input type=\"text\" class=\"temp\"/>"
                            +"</div>"
                            +"<div class=\"double-cell\">"
                            +"<input type=\"text\" class=\"tas\"/><br/>"
                            +"<input type=\"text\" class=\"cas\"/>"
                            +"</div>"
                            +"<input type=\"text\" class=\"trk thick\"/>"
                            +"<input type=\"text\" class=\"wv\"/>"
                            +"<input type=\"text\" class=\"hdg thick\"/>"
                            +"<input type=\"text\" class=\"gs\"/>"
                            +"<input type=\"text\" class=\"dist\"/>"
                            +"<input type=\"text\" class=\"fuel\"/>"
                            +"<input type=\"text\" class=\"ete\"/>"
                            +"<div><button style=\"background-color:#f00;\" onclick=\"javascript:delLeg(this)\">X</button></div>"
                            +"</div>";
            document.getElementById('nlc').appendChild(div);
        }
        
        function delLeg(x){
            var target = x.parentNode.parentNode;
            target.parentNode.removeChild(target);
        }
        
        function calc(){
            tot_dist=0.0;
            tot_fuel=0.0;
            tot_ete=0.0;

            //filler variables
            var alt_this = alts[0].value;
            var tas_this = tass[0].value;
            var wv_this = winds[0].value;
            
            //loop
            for(var x=0; x<alts.length; x++){
                alts[x].value!=""?alt_this=alts[x].value:alts[x].value=alt_this;
                tass[x].value!=""?tas_this=tass[x].value:tass[x].value=tas_this;
                winds[x].value!= ""?wv_this=winds[x].value:winds[x].value=wv_this;
                
                //calculating wind correction angle and (mag) heading
                var tmp = winds[x].value;
                var wv_c = [tmp.slice(0,3), tmp.slice(3)];
                var trk = parseInt(tracks[x].value);
                trk = trk==0?360:trk;
                var d = parseInt(wv_c[0])-trk;
                d = d>180?d-360:d;
                
                var wca = Math.asin(parseFloat(wv_c[1])/parseFloat(tas_this)*Math.sin(d*Math.PI/180.0))*180.0/Math.PI;
                //rounding off
                wca = 1.0*Math.round(wca);
                hdg = trk + wca;
                hdg = hdg>360?hdg-360:(hdg<0?360+hdg:hdg);
                
                //formatting with 0s
                headings[x].value = hdg<10?"00"+hdg:(hdg<100?"0"+hdg:hdg);
                
                //calculating ground speed
                var tas_c = Math.cos(Math.abs(wca)*Math.PI/180.0)*parseInt(tas_this); //trk component of AS
                var hwd_c = Math.cos(d*Math.PI/180.0)*parseInt(wv_c[1]); //headwind component
                var gs = Math.round(tas_c - hwd_c); //groundspeed
                ground_speeds[x].value = gs;
                
                var d_t = parseFloat(distances[x].value);
                tot_dist+= d_t;

                //calculating fuel and ETE
                var ete = d_t/gs;
                var fuel = 0;

                if(fuel = ete*parseFloat(document.getElementById('gph').value)){
                    fuel_reqs[x].value = fuel.toFixed(1);
                    tot_fuel+= parseFloat(fuel.toFixed(1));
                }
                etes[x].value = (ete*60).toFixed(1);

                tot_ete+= parseFloat((ete*60).toFixed(1));
            }

            document.getElementById('tot_dist').innerHTML = "<b>"+tot_dist+"</b>";
            document.getElementById('tot_fuel').innerHTML = "<b>"+tot_fuel+"</b>";
            document.getElementById('tot_ete').innerHTML = "<b>"+tot_ete.toFixed(1)+"</b>";
        }

        function recalc(){
            tot_fuel=0.0;
            tot_ete=0.0;

            for(var x=0; x<fuel_reqs.length; x++){
                if(fuel_reqs[x].value.includes("+")){
                    var t_f_s_a = fuel_reqs[x].value.split("+");
                    for(var y=0; y<t_f_s_a.length; y++){
                        tot_fuel+= parseFloat(t_f_s_a[y]);
                    }
                }
                else{
                    tot_fuel+= parseFloat(fuel_reqs[x].value);
                }

                if(etes[x].value.includes("+")){
                    var e_f_s_a = etes[x].value.split("+");
                    for(var y=0; y<e_f_s_a.length; y++){
                        tot_ete+= parseFloat(e_f_s_a[y]);
                    }
                }
                else{
                    tot_ete += parseFloat(etes[x].value);
                }
            }

            document.getElementById('tot_fuel').innerHTML = "<b>" + tot_fuel.toFixed(1) + "</b>";
            document.getElementById('tot_ete').innerHTML = "<b>" + tot_ete.toFixed(1) + "</b>";
        }

        function saveNavlog(){
            var tt="";
            do{
                tt = prompt("Save Navlog As...", this_navlog_title);
            }while(tt=="");

            if(tt==null){
                return;
            }
            
            this_navlog_title = tt;
            var this_navlog = "";
            
            //fetching data
            var len = alts.length;
            for(var x=0; x<len; x++){
                this_navlog+= legNames[x].value.replaceAll('\n','#')+":"+alts[x].value+":"+tracks[x].value+":"+distances[x].value+"?";
            }

            document.cookie = "VFRNL-"+this_navlog_title+"="+this_navlog+"; SameSite=Strict; expires=Mon, 18 Jan 2038 00:00:00 UTC;";

            alert("Navlog \'"+this_navlog_title+"\' saved successfully on this browser!");
        }

        function manageNavlogs(){
            document.getElementById('nav-manager-overlay').style.display = "block";
            var navlog_list = "";
            document.cookie.split("; ").forEach(function(arrX){
                if(arrX.startsWith("VFRNL")){
                    navlog_list = "<tr><td>"+arrX.split("=")[0].substring(6)+"</td> <td><a href=\"#\" onclick=\"javascript:loadNavlog(this)\">Load</a></td> <td><a href=\"#\" onclick=\"javascript:deleteNavlog(this)\">Delete</a></td></tr>"
                                    +navlog_list;
                }
            });

            if(navlog_list!=""){
                document.getElementById('navlog-list').innerHTML = navlog_list;
            }
        }

        function closeNavManager(){
            document.getElementById('nav-manager-overlay').style.display = "none";
        }

        function loadNavlog(n){
            //resetting current navlog
            document.getElementById('nlc').innerHTML = "<div class=\"navlog-row\">"
                                                        +"<textarea disabled>From/&#13;To</textarea>"
                                                        +"<div class=\"double-cell\">"
                                                        +"<input value=\"Alt\" disabled/><br/>"
                                                        +"<input value=\"Temp\" disabled/>"
                                                        +"</div>"
                                                        +"<div class=\"double-cell\">"
                                                        +"<input value=\"TAS\" disabled/><br/>"
                                                        +"<input value=\"CAS\" disabled/>"
                                                        +"</div>"
                                                        +"<input value=\"Trk\" disabled/>"
                                                        +"<input value=\"W/V\" disabled/>"
                                                        +"<input value=\"Hdg\" disabled/>"
                                                        +"<input value=\"GS\" disabled/>"
                                                        +"<input value=\"Dist\" disabled/>"
                                                        +"<div class=\"double-cell\">"
                                                        +"<input value=\"Fuel\" disabled/><br/>"
                                                        +"<input placeholder=\"g.p.h.\" id=\"gph\"/>"
                                                        +"</div>"
                                                        +"<input value=\"ETE\" disabled/>"
                                                        +"</div>";

            this_navlog_title = n.parentElement.parentElement.firstChild.innerHTML;
            document.cookie.split("; ").forEach(function(arrX){
                if(arrX.startsWith("VFRNL-"+this_navlog_title)){
                    var nr_s = arrX.split("=")[1].split("?");
                    for(var a=0; a<nr_s.length; a++){
                        if(nr_s[a]!=""){
                            var nrvs = nr_s[a].split(":");
                            addLeg();
                            legNames[a].value = nrvs[0].replaceAll('#', '\n');
                            alts[a].value = nrvs[1];
                            tracks[a].value = nrvs[2];
                            distances[a].value = nrvs[3];
                        }
                    }

                    return;
                }
            });
        }

        function deleteNavlog(n){

        }
    </script>
</html>